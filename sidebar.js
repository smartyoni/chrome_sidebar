document.addEventListener('DOMContentLoaded', async () => {
    // DOM ÏöîÏÜåÎì§
    const memoForm = document.getElementById('memo-form');
    const memoInput = document.getElementById('memo-input');
    const categoryAccordion = document.getElementById('category-accordion');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const viewModal = document.getElementById('view-modal');
    const editModal = document.getElementById('edit-modal');
    const closeModalBtns = document.querySelectorAll('.close-btn');
    const editForm = document.getElementById('edit-form');
    const editContent = document.getElementById('edit-content');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const datetimeElement = document.getElementById('current-datetime');

    // ÏÉÅÌÉú Î≥ÄÏàòÎì§
    let categories = [];
    let memos = [];
    let expandedCategories = new Set();
    let currentEditingMemoId = null;

    // Í∏∞Î≥∏ Ïπ¥ÌÖåÍ≥†Î¶¨ Îç∞Ïù¥ÌÑ∞
    const defaultCategories = [
        { name: 'Í≥ÑÏïΩ', color: '#3498db', icon: 'üìÑ' },
        { name: 'Í¥ëÍ≥†', color: '#e74c3c', icon: 'üì¢' },
        { name: 'Í∏∞ÌÉÄ', color: '#95a5a6', icon: 'üìå' }
    ];

    // Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è Ï†ÄÏû•
    const loadData = async () => {
        try {
            const result = await chrome.storage.local.get(['memos', 'categories', 'expandedCategories']);
            memos = result.memos || [];
            categories = result.categories || defaultCategories;
            expandedCategories = new Set(result.expandedCategories || []);
        } catch (error) {
            console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
            categories = defaultCategories;
            memos = [];
            expandedCategories = new Set();
        }
    };

    const saveData = async () => {
        try {
            await chrome.storage.local.set({
                memos: memos,
                categories: categories,
                expandedCategories: Array.from(expandedCategories)
            });
        } catch (error) {
            console.error('Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ïã§Ìå®:', error);
        }
    };

    // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
    const generateId = () => Date.now().toString() + Math.random().toString(36).substr(2, 9);

    const getFirstLine = (text) => {
        const lines = text.trim().split('\n');
        return lines[0] || 'Ï†úÎ™© ÏóÜÏùå';
    };

    const linkify = (text) => {
        if (!text) return '';
        
        // ÎßàÌÅ¨Îã§Ïö¥ ÎßÅÌÅ¨ Ï≤òÎ¶¨
        text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
        
        // ÏùºÎ∞ò URL Ï≤òÎ¶¨
        const urlRegex = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])|(\bwww\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;
        text = text.replace(urlRegex, (url) => {
            if (text.includes(`href="${url}`) || text.includes(`href="http://${url.replace('www.', '')}`)) {
                return url;
            }
            let href = url.startsWith('www.') ? 'http://' + url : url;
            return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
        });
        
        return text;
    };

    // ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
    const updateDateTime = () => {
        const now = new Date();
        const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const date = now.getDate();
        const dayOfWeek = days[now.getDay()];
        let hours = now.getHours();
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const ampm = hours >= 12 ? 'Ïò§ÌõÑ' : 'Ïò§Ï†Ñ';
        hours = hours % 12;
        hours = hours ? hours : 12;

        const formattedDateTime = `${year}ÎÖÑ ${month}Ïõî ${date}Ïùº (${dayOfWeek}) ${ampm} ${hours}:${minutes}`;
        datetimeElement.textContent = formattedDateTime;
    };

    // Ïπ¥ÌÖåÍ≥†Î¶¨ Î†åÎçîÎßÅ
    const renderCategories = () => {
        categoryAccordion.innerHTML = '';

        categories.forEach(category => {
            const categoryMemos = memos.filter(memo => memo.category === category.name);
            const bookmarkedMemos = categoryMemos.filter(memo => memo.isBookmarked);
            const regularMemos = categoryMemos.filter(memo => !memo.isBookmarked);
            const sortedMemos = [...bookmarkedMemos, ...regularMemos];

            const categoryContainer = document.createElement('div');
            categoryContainer.className = 'category-container';
            categoryContainer.dataset.category = category.name;

            const isExpanded = expandedCategories.has(category.name);

            categoryContainer.innerHTML = `
                <button class="category-header ${isExpanded ? 'active' : ''}" data-category="${category.name}">
                    <div class="category-title">
                        <span style="font-size: 18px;">${category.icon}</span>
                        <span>${category.name}</span>
                        <span class="memo-count">${categoryMemos.length}</span>
                    </div>
                    <div class="category-actions">
                        <button class="edit-category-btn" data-category="${category.name}" title="Ïù¥Î¶Ñ ÏàòÏ†ï">ÏàòÏ†ï</button>
                        <button class="delete-category-btn" data-category="${category.name}" title="Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÇ≠Ï†ú">ÏÇ≠Ï†ú</button>
                        <span class="category-toggle ${isExpanded ? 'expanded' : ''}">‚ñº</span>
                    </div>
                </button>
                <ul class="memo-list ${isExpanded ? 'expanded' : ''}" data-category="${category.name}">
                    ${sortedMemos.length === 0 
                        ? '<div class="empty-category"><p>Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§.</p></div>'
                        : sortedMemos.map(memo => `
                            <li class="memo-item ${memo.isBookmarked ? 'bookmarked' : ''}" data-id="${memo.id}">
                                <div class="memo-header">
                                    <div class="memo-title">${getFirstLine(memo.content)}</div>
                                    <div class="memo-actions">
                                        <button class="bookmark-btn ${memo.isBookmarked ? 'bookmarked' : ''}" data-id="${memo.id}">
                                            ${memo.isBookmarked ? '‚≠ê' : '‚òÜ'}
                                        </button>
                                    </div>
                                </div>
                                <div class="memo-preview">${memo.content.substring(0, 100)}${memo.content.length > 100 ? '...' : ''}</div>
                            </li>
                        `).join('')
                    }
                </ul>
            `;

            categoryAccordion.appendChild(categoryContainer);
        });

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        attachCategoryEventListeners();
    };

    // Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    const attachCategoryEventListeners = () => {
        // Ïπ¥ÌÖåÍ≥†Î¶¨ Ìó§Îçî ÌÅ¥Î¶≠ (ÌôïÏû•/Ï∂ïÏÜå)
        categoryAccordion.querySelectorAll('.category-header').forEach(header => {
            header.addEventListener('click', (e) => {
                // Ìé∏Ïßë/ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú ÏïÑÏΩîÎîîÏñ∏ ÌÜ†Í∏Ä Î∞©ÏßÄ
                if (e.target.classList.contains('edit-category-btn') || 
                    e.target.classList.contains('delete-category-btn') ||
                    e.target.closest('.edit-category-btn') ||
                    e.target.closest('.delete-category-btn')) {
                    return;
                }

                e.preventDefault();
                e.stopPropagation();

                const categoryName = header.dataset.category;
                const memoList = header.nextElementSibling;
                const toggle = header.querySelector('.category-toggle');

                console.log('ÌÜ†Í∏Ä ÌÅ¥Î¶≠:', categoryName, expandedCategories.has(categoryName));

                if (expandedCategories.has(categoryName)) {
                    // Ï∂ïÏÜå
                    expandedCategories.delete(categoryName);
                    header.classList.remove('active');
                    memoList.classList.remove('expanded');
                    if (toggle) toggle.classList.remove('expanded');
                } else {
                    // ÌôïÏû•
                    expandedCategories.add(categoryName);
                    header.classList.add('active');
                    memoList.classList.add('expanded');
                    if (toggle) toggle.classList.add('expanded');
                }

                saveData();
            });
        });

        // Ïπ¥ÌÖåÍ≥†Î¶¨ Ìé∏Ïßë/ÏÇ≠Ï†ú Î≤ÑÌäº
        categoryAccordion.querySelectorAll('.edit-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                editCategoryName(btn.dataset.category);
            });
        });

        categoryAccordion.querySelectorAll('.delete-category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteCategory(btn.dataset.category);
            });
        });

        // Î©îÎ™® ÌÅ¥Î¶≠
        categoryAccordion.querySelectorAll('.memo-item').forEach(item => {
            item.addEventListener('click', (e) => {
                if (e.target.classList.contains('bookmark-btn')) {
                    return;
                }
                const memoId = item.dataset.id;
                showMemoModal(memoId);
            });
        });

        // Î∂ÅÎßàÌÅ¨ Î≤ÑÌäº
        categoryAccordion.querySelectorAll('.bookmark-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleBookmark(btn.dataset.id);
            });
        });
    };

    // Î©îÎ™® Í¥ÄÎ†® Ìï®ÏàòÎì§
    const addMemo = async (content) => {
        if (!content.trim()) return;

        const firstCategory = categories[0];
        if (!firstCategory) return;

        const newMemo = {
            id: generateId(),
            content: content.trim(),
            category: firstCategory.name,
            isBookmarked: false,
            createdAt: new Date().toISOString()
        };

        memos.unshift(newMemo);
        await saveData();
        renderCategories();
    };

    const showMemoModal = (memoId) => {
        const memo = memos.find(m => m.id === memoId);
        if (!memo) return;

        document.getElementById('view-title').textContent = getFirstLine(memo.content);
        
        // ÎßàÌÅ¨Îã§Ïö¥ ÏßÄÏõêÏù¥ ÏûàÎã§Î©¥ ÏÇ¨Ïö©, ÏóÜÎã§Î©¥ Í∏∞Î≥∏ ÎßÅÌÅ¨ Ï≤òÎ¶¨
        let processedContent;
        if (typeof marked !== 'undefined') {
            processedContent = marked.parse ? marked.parse(memo.content) : marked(memo.content);
        } else {
            processedContent = linkify(memo.content.replace(/\n/g, '<br>'));
        }
        
        document.getElementById('view-content').innerHTML = processedContent;

        // Î™®Îã¨ Ìë∏ÌÑ∞Ïóê Î≤ÑÌäºÎì§ Ï∂îÍ∞Ä
        const modalFooter = document.getElementById('view-modal-footer');
        modalFooter.innerHTML = `
            <button class="modal-btn copy-btn" data-memo-id="${memoId}">Î≥µÏÇ¨</button>
            <button class="modal-btn edit-btn" data-memo-id="${memoId}">ÏàòÏ†ï</button>
            <button class="modal-btn delete-btn" data-memo-id="${memoId}">ÏÇ≠Ï†ú</button>
        `;

        // Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
        const copyBtn = modalFooter.querySelector('.copy-btn');
        const editBtn = modalFooter.querySelector('.edit-btn');
        const deleteBtn = modalFooter.querySelector('.delete-btn');

        copyBtn.addEventListener('click', () => copyMemoContent(memoId));
        editBtn.addEventListener('click', () => editMemo(memoId));
        deleteBtn.addEventListener('click', () => deleteMemo(memoId));

        viewModal.style.display = 'block';
    };

    const toggleBookmark = async (memoId) => {
        const memo = memos.find(m => m.id === memoId);
        if (!memo) return;

        memo.isBookmarked = !memo.isBookmarked;
        await saveData();
        renderCategories();
    };

    // Î©îÎ™® Ïï°ÏÖò Ìï®ÏàòÎì§
    const copyMemoContent = async (memoId) => {
        const memo = memos.find(m => m.id === memoId);
        if (!memo) return;

        try {
            await navigator.clipboard.writeText(memo.content);
            const copyBtn = document.querySelector('.copy-btn');
            if (copyBtn) {
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'Î≥µÏÇ¨ ÏôÑÎ£å!';
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                }, 1500);
            }
        } catch (error) {
            console.error('Î≥µÏÇ¨ Ïã§Ìå®:', error);
        }
    };

    const editMemo = (memoId) => {
        const memo = memos.find(m => m.id === memoId);
        if (!memo) return;

        currentEditingMemoId = memoId;
        editContent.value = memo.content;
        viewModal.style.display = 'none';
        editModal.style.display = 'block';
    };

    const deleteMemo = async (memoId) => {
        if (!confirm('Ïù¥ Î©îÎ™®Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

        memos = memos.filter(m => m.id !== memoId);
        await saveData();
        renderCategories();
        viewModal.style.display = 'none';
    };

    // Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
    const addCategory = async () => {
        const categoryName = prompt('ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
        if (!categoryName || !categoryName.trim()) return;

        const trimmedName = categoryName.trim();
        if (categories.find(c => c.name === trimmedName)) {
            alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ïπ¥ÌÖåÍ≥†Î¶¨ÏûÖÎãàÎã§.');
            return;
        }

        const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
        const icons = ['üìù', 'üíº', 'üéØ', 'üí°', 'üìä', 'üîñ', 'üìå', 'üé®', 'üî¨', 'üé≠'];
        
        const newCategory = {
            name: trimmedName,
            color: colors[Math.floor(Math.random() * colors.length)],
            icon: icons[Math.floor(Math.random() * icons.length)]
        };

        categories.push(newCategory);
        expandedCategories.add(trimmedName);
        await saveData();
        renderCategories();
    };

    const editCategoryName = async (oldName) => {
        const newName = prompt('ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', oldName);
        if (!newName || !newName.trim() || newName.trim() === oldName) return;

        const trimmedName = newName.trim();
        if (categories.find(c => c.name === trimmedName)) {
            alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ïπ¥ÌÖåÍ≥†Î¶¨ÏûÖÎãàÎã§.');
            return;
        }

        // Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ ÏóÖÎç∞Ïù¥Ìä∏
        const category = categories.find(c => c.name === oldName);
        if (category) {
            category.name = trimmedName;
        }

        // Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò Î™®Îì† Î©îÎ™® ÏóÖÎç∞Ïù¥Ìä∏
        memos.forEach(memo => {
            if (memo.category === oldName) {
                memo.category = trimmedName;
            }
        });

        // ÌôïÏû• ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        if (expandedCategories.has(oldName)) {
            expandedCategories.delete(oldName);
            expandedCategories.add(trimmedName);
        }

        await saveData();
        renderCategories();
    };

    const deleteCategory = async (categoryName) => {
        const categoryMemos = memos.filter(m => m.category === categoryName);
        const confirmMessage = categoryMemos.length > 0 
            ? `'${categoryName}' Ïπ¥ÌÖåÍ≥†Î¶¨ÏôÄ Ìè¨Ìï®Îêú ${categoryMemos.length}Í∞úÏùò Î©îÎ™®Î•º Î™®Îëê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`
            : `'${categoryName}' Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;

        if (!confirm(confirmMessage)) return;

        // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÇ≠Ï†ú
        categories = categories.filter(c => c.name !== categoryName);
        
        // Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò Î™®Îì† Î©îÎ™® ÏÇ≠Ï†ú
        memos = memos.filter(m => m.category !== categoryName);
        
        // ÌôïÏû• ÏÉÅÌÉúÏóêÏÑú Ï†úÍ±∞
        expandedCategories.delete(categoryName);

        await saveData();
        renderCategories();
    };

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎì§
    memoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const content = memoInput.value.trim();
        if (!content) return;

        await addMemo(content);
        memoInput.value = '';
    });

    addCategoryBtn.addEventListener('click', addCategory);

    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentEditingMemoId) return;

        const newContent = editContent.value.trim();
        if (!newContent) return;

        const memo = memos.find(m => m.id === currentEditingMemoId);
        if (memo) {
            memo.content = newContent;
            await saveData();
            renderCategories();
        }

        editModal.style.display = 'none';
        currentEditingMemoId = null;
    });

    cancelEditBtn.addEventListener('click', () => {
        editModal.style.display = 'none';
        currentEditingMemoId = null;
    });

    // Î™®Îã¨ Îã´Í∏∞
    closeModalBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            const modal = e.target.closest('.modal');
            if (modal) {
                modal.style.display = 'none';
                if (modal === editModal) {
                    currentEditingMemoId = null;
                }
            }
        });
    });

    // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ÏúºÎ°ú Îã´Í∏∞
    window.addEventListener('click', (e) => {
        if (e.target === viewModal) {
            viewModal.style.display = 'none';
        }
        if (e.target === editModal) {
            editModal.style.display = 'none';
            currentEditingMemoId = null;
        }
    });

    // Ï¥àÍ∏∞Ìôî
    const initialize = async () => {
        console.log('Ïï± Ï¥àÍ∏∞Ìôî ÏãúÏûë');
        await loadData();
        console.log('Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', { categories: categories.length, memos: memos.length, expandedCategories: Array.from(expandedCategories) });
        
        // Ï≤´ Î≤àÏß∏ Ïπ¥ÌÖåÍ≥†Î¶¨Î•º Í∏∞Î≥∏ÏúºÎ°ú ÌôïÏû•
        if (categories.length > 0 && expandedCategories.size === 0) {
            expandedCategories.add(categories[0].name);
            console.log('Ï≤´ Î≤àÏß∏ Ïπ¥ÌÖåÍ≥†Î¶¨ ÌôïÏû•:', categories[0].name);
            await saveData();
        }
        
        renderCategories();
        updateDateTime();
        setInterval(updateDateTime, 1000);
        console.log('Ïï± Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
    };

    // Ïï± ÏãúÏûë
    await initialize();
});